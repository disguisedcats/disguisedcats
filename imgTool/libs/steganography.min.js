(function(e,t,r){"undefined"!=typeof module&&module.exports?module.exports=r():"function"==typeof define&&define.amd?define(r):t.steg=r()}(0,this,(function(){var e=function(){},t={isPrime:function(e){if(isNaN(e)||!isFinite(e)||e%1||e<2)return!1;if(e%2==0)return 2===e;if(e%3==0)return 3===e;for(var t=Math.sqrt(e),r=5;r<=t;r+=6){if(e%r==0)return!1;if(e%(r+2)==0)return!1}return!0},findNextPrime:function(e){for(var r=e;;r+=1)if(t.isPrime(r))return r},sum:function(e,t,r){for(var n=0,i=(r=r||{}).start||0;i<t;i+=r.inc||1)n+=e(i)||0;return 0===n&&r.defValue?r.defValue:n},product:function(e,t,r){for(var n=1,i=(r=r||{}).start||0;i<t;i+=r.inc||1)n*=e(i)||1;return 1===n&&r.defValue?r.defValue:n},createArrayFromArgs:function(e,t,r){for(var n=new Array(r-1),i=0;i<r;i+=1)n[i]=e(i>=t?i+1:i);return n},loadImg:function(e){var t=new Image;return t.src=e,t}};return e.prototype.config={t:3,threshold:1,codeUnitSize:16,args:function(e){return e+1},messageDelimiter:function(e,t){for(var r=new Array(3*t),n=0;n<r.length;n+=1)r[n]=255;return r},messageCompleted:function(e,t,r){for(var n=!0,i=0;i<16&&n;i+=1)n=n&&255===e[t+4*i];return n}},e.prototype.getHidingCapacity=function(e,t){t=t||{};var r=this.config,n=t.width||e.width,i=t.height||e.height;return(t.t||r.t)*n*i/(t.codeUnitSize||r.codeUnitSize)>>0},e.prototype.encode=function(e,r,n){if(r.length)r=t.loadImg(r);else if(r.src)r=t.loadImg(r.src);else if(!(r instanceof HTMLImageElement))throw new Error("IllegalInput: The input image is neither an URL string nor an image.");n=n||{};var i=this.config,a=n.t||i.t,o=n.threshold||i.threshold,h=n.codeUnitSize||i.codeUnitSize,g=t.findNextPrime(Math.pow(2,a)),d=n.args||i.args,f=n.messageDelimiter||i.messageDelimiter;if(!a||a<1||a>7)throw new Error('IllegalOptions: Parameter t = " + t + " is not valid: 0 < t < 8');var l=document.createElement("canvas"),s=l.getContext("2d");l.style.display="none",l.width=n.width||r.width,l.height=n.height||r.height,n.height&&n.width?s.drawImage(r,0,0,n.width,n.height):s.drawImage(r,0,0);var u,m,c,p,w,v,I,M,y,C=s.getImageData(0,0,l.width,l.height),U=C.data,S=h/a>>0,x=h%a,E=[];for(M=0;M<=e.length;M+=1){if(w=e.charCodeAt(M)||0,(v=x*M%a)>0&&m){if(c=(w&(I=Math.pow(2,a-v)-1))<<v,p=(m&Math.pow(2,h)*(1-Math.pow(2,-v)))>>h-v,E.push(c+p),M<e.length){for(I=Math.pow(2,2*a-v)*(1-Math.pow(2,-a)),y=1;y<S;y+=1)u=w&I,E.push(u>>(y-1)*a+(a-v)),I<<=a;x*(M+1)%a==0?(u=w&(I=Math.pow(2,h)*(1-Math.pow(2,-a))),E.push(u>>h-a)):x*(M+1)%a+(a-v)<=a&&(u=w&I,E.push(u>>(S-1)*a+(a-v)))}}else if(M<e.length)for(I=Math.pow(2,a)-1,y=0;y<S;y+=1)u=w&I,E.push(u>>y*a),I<<=a;m=w}var z,D,P,A,L,N=f(E,o);for(z=0;4*(z+o)<=U.length&&z+o<=E.length;z+=o){for(L=[],M=0;M<o&&M+z<E.length;M+=1){for(A=0,y=z;y<o+z&&y<E.length;y+=1)A+=E[y]*Math.pow(d(M),y-z);L[M]=255-g+1+A%g}for(M=4*z;M<4*(z+L.length)&&M<U.length;M+=4)U[M+3]=L[M/4%o];P=L.length}for(D=z+P;D-(z+P)<N.length&&4*(z+N.length)<U.length;D+=1)U[4*D+3]=N[D-(z+P)];for(M=4*(D+1)+3;M<U.length;M+=4)U[M]=255;return C.data=U,s.putImageData(C,0,0),l.toDataURL()},e.prototype.decode=function(e,r){if(e.length)e=t.loadImg(e);else if(e.src)e=t.loadImg(e.src);else if(!(e instanceof HTMLImageElement))throw new Error("IllegalInput: The input image is neither an URL string nor an image.");r=r||{};var n=this.config,i=r.t||n.t,a=r.threshold||n.threshold,o=r.codeUnitSize||n.codeUnitSize,h=t.findNextPrime(Math.pow(2,i)),g=(r.args||n.args,r.messageCompleted||n.messageCompleted);if(!i||i<1||i>7)throw new Error('IllegalOptions: Parameter t = " + t + " is not valid: 0 < t < 8');var d=document.createElement("canvas"),f=d.getContext("2d");d.style.display="none",d.width=r.width||e.width,d.height=r.width||e.height,r.height&&r.width?f.drawImage(e,0,0,r.width,r.height):f.drawImage(e,0,0);var l,s,u=f.getImageData(0,0,d.width,d.height).data,m=[];if(1===a)for(l=3,s=!1;!s&&l<u.length&&!s;l+=4)(s=g(u,l,a))||m.push(u[l]-(255-h+1));var c="",p=0,w=0,v=Math.pow(2,o)-1;for(l=0;l<m.length;l+=1)p+=m[l]<<w,(w+=i)>=o&&(c+=String.fromCharCode(p&v),w%=o,p=m[l]>>i-w);return 0!==p&&(c+=String.fromCharCode(p&v)),c},new e})));